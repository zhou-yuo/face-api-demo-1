<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./vite.svg" />
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
  <title>Vite + Vue</title>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    var vConsole = new window.VConsole();
  </script>
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/vant/2.12.25/vant.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/tensorflow/3.19.0/tf.min.js"></script>
  <script src="https://unpkg.com/@mediapipe/face_mesh"></script>
  <script src="https://unpkg.com/@tensorflow-models/face-landmarks-detection"></script>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    /*定义滚动条高宽及背景 高宽分别对应横竖滚动条的尺寸*/
    ::-webkit-scrollbar {
      width: 7px;
      height: 7px;
      background-color: #f5f5f5;
    }

    /*定义滚动条轨道 内阴影+圆角*/
    ::-webkit-scrollbar-track {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      background-color: #f5f5f5;
    }

    /*定义滑块 内阴影+圆角*/
    ::-webkit-scrollbar-thumb {
      border-radius: 10px;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
      -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
      background-color: #c8c8c8;
    }

    [v-cloak] {
      opacity: 0 !important;
    }

    #app {
      margin: 0 auto;
      max-width: 800px;
    }

    .Camera-wrapper {
      margin: 1em auto;
      position: relative;
      overflow: hidden;
    }

    .van-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .canvas-wrapper {
      position: relative;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      margin: 0 auto;
      border-radius: 50%;
      overflow: hidden;
    }

    .canvas-wrapper>video {
      background: #000;
      border-radius: 50%;
      overflow: hidden;
    }

    .canvas-wrapper>canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      border-radius: 50%;
      overflow: hidden;
    }

    .videoDialog .van-dialog__message {
      line-height: 1;
      white-space: unset;
    }

    .FlipHorizontal-toggle {
      right: 10vw;
    }

    .Camera-toggle {
      left: 10vw;
    }

    .FlipHorizontal-toggle,
    .Camera-toggle {
      position: fixed;
      bottom: 5vh;
      width: 15vw;
      height: 15vw;
      max-width: 50px;
      max-height: 50px;
      background-color: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20vw;
      -webkit-tap-highlight-color: transparent;
      z-index: 10;
      opacity: 0.8;
    }

    .FlipHorizontal-toggle>svg,
    .Camera-toggle>svg {
      width: 7vw;
      max-width: 30px;
      transition: 0.5s;
      transform: scaleX(1);
    }

    .FlipHorizontalIng>svg {
      transform: scaleX(-1);
    }

    .btn-operate {
      text-align: center;
      padding: 15px;
    }

    .btn-operate>button {
      min-width: 160px;
      border-radius: 5px;
    }

    .prompt-text {
      padding: 15px;
      color: #000;
      margin-top: 1em;
    }

    .prompt-text>h5 {
      opacity: 0.9;
      padding-bottom: 1em;
    }

    .prompt-text>ol {
      opacity: 0.7;
      list-style: revert;
      font-size: 13px;
      line-height: 1.7;
      padding-left: 1em;
    }

    .van-notice-bar {
      width: 60%;
      margin: 1em auto 0 auto;
      border-radius: 100px;
      overflow: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      text-align: center;
    }

    .van-notice-bar .van-notice-bar__content,
    .van-notice-bar .van-swipe-item {
      width: 100%;
    }

    .notice-swipe {
      height: 40px;
      line-height: 40px;
    }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <van-notice-bar color="#1989fa" background="#ecf9ff" :scrollable="false">
      <van-swipe ref="actionSwipe" vertical class="notice-swipe" :show-indicators="false" :touchable="false">
        <van-swipe-item v-for="(item,index) in currentAction" :key="index">{{item.name}}</van-swipe-item>
        <van-swipe-item v-if="!isObjEmpty(currentAction)">已完成</van-swipe-item>
      </van-swipe>
    </van-notice-bar>
    <div class="Camera-wrapper" :style="{width:width+7+'px',height:height+7+'px'}">
      <div class="canvas-wrapper" :style="{width:width+'px',height:height+'px'}">
        <video ref="video" :width="width" :height="height" webkit-playsinline="true" playsinline="true" preload autoplay
          loop muted></video>
        <canvas ref="canvas" :width="width" :height="height"></canvas>
      </div>
      <van-circle v-model="currentRate" :style="{width:width+7+'px',height:height+7+'px'}" :rate="0" :speed="100"
        stroke-width="20" layer-color="#ebedf0"></van-circle>
    </div>
    <div class="btn-operate">
      <van-button @click="startMediaRecorder" v-if="isCameraOpen && !inProgress" type="info" native-type="button">开始录制
      </van-button>
      <van-button v-if="isCameraOpen && inProgress" type="danger" native-type="button" disabled>录制中</van-button>
      <van-button @click="neuAufnehmen" v-if="!isCameraOpen && !inProgress" type="default" native-type="button">重新录制
      </van-button>
    </div>
    <div class="prompt-text">
      <h5>视频录制说明</h5>
      <ol>
        <li>请使用前置摄像头。</li>
        <li>脸部距离屏幕应该控制<span ref="faceProportion"></span>。</li>
        <li>保证光线充足、脸部完全入镜、脸部无遮挡物。</li>
        <li>开始录制后请按照提示做出相应动作。</li>
        <li>如录制不满意可点击“重新录制”。</li>
        <li>底部按钮：左边切换摄像头、右边切换镜像</li>
      </ol>
    </div>
    <div style="height: calc(5vh + 70px )"></div>
    <!-- 切换摄像头 -->
    <div class="Camera-toggle" title="切换摄像头" @click="actionShow = true">
      <svg t="1658028836694" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="5841" width="200" height="200">
        <path
          d="M868.355 291.969l-95.558-15.726-29.174-72.070c-16.743-41.3-56.578-67.992-101.478-67.992l-260.384 0c-44.855 0-84.709 26.682-101.565 68.042l-29.128 72.019-95.517 15.726c-53.023 8.687-91.504 53.659-91.504 106.941v385.782c0 59.772 49.065 108.406 109.372 108.406h677.035c60.322 0 109.403-48.623 109.403-108.396v-385.792c0-53.282-38.481-98.254-91.499-106.941zM897.356 784.703c0 25.308-21.036 45.897-46.904 45.897h-677.035c-25.848 0-46.874-20.599-46.874-45.908l0-385.782c0-22.512 16.449-41.553 39.132-45.267l112.856-18.584c10.752-1.77 19.805-9.012 23.894-19.113l35.68-88.214c7.192-17.649 24.327-29.052 43.654-29.052h260.384c19.327 0 36.427 11.373 43.558 28.961l35.755 88.315c4.079 10.091 13.132 17.334 23.884 19.103l112.882 18.584c0.010 0 0.020 0 0.020 0.010 22.664 3.702 39.112 22.745 39.112 45.257l0 385.793z"
          p-id="5842" fill="#ffffff"></path>
        <path
          d="M436.876 473.188c-17.257 0-31.249 13.987-31.249 31.249v30.486c0 17.262 13.992 31.249 31.249 31.249s31.249-13.987 31.249-31.249v-30.486c0-17.261-13.992-31.249-31.249-31.249z"
          p-id="5843" fill="#ffffff"></path>
        <path
          d="M587.024 473.188c-17.262 0-31.249 13.987-31.249 31.249v30.486c0 17.262 13.987 31.249 31.249 31.249s31.249-13.987 31.249-31.249v-30.486c0-17.261-13.987-31.249-31.249-31.249z"
          p-id="5844" fill="#ffffff"></path>
        <path
          d="M768.412 403.814c-12.207-12.207-31.981-12.207-44.188 0l-19.261 19.262c-39.232-69.398-114.001-114.87-195.852-114.87-98.691 0-187.276 66.007-215.417 160.518-4.923 16.54 4.496 33.945 21.036 38.868 16.57 4.923 33.945-4.496 38.868-21.026 20.309-68.215 84.257-115.862 155.513-115.862s135.209 47.647 155.523 115.862c0.162 0.541 0.418 1.025 0.605 1.551 0.261 0.734 0.529 1.455 0.847 2.171 0.521 1.178 1.126 2.287 1.775 3.371 0.309 0.516 0.577 1.044 0.919 1.544 1.101 1.619 2.316 3.135 3.678 4.499 0.011 0.011 0.017 0.025 0.030 0.036 0.071 0.071 0.156 0.115 0.226 0.185 1.284 1.258 2.68 2.377 4.151 3.39 0.533 0.368 1.083 0.68 1.632 1.012 1.070 0.645 2.165 1.226 3.304 1.74 0.627 0.281 1.249 0.557 1.891 0.796 1.224 0.457 2.478 0.811 3.757 1.114 0.525 0.123 1.035 0.289 1.564 0.384 1.824 0.333 3.676 0.544 5.561 0.544 1.77 0 3.56-0.208 5.352-0.523 0.558-0.096 1.102-0.238 1.655-0.365 0.643-0.148 1.283-0.234 1.925-0.425 0.45-0.134 0.837-0.371 1.277-0.525 1.057-0.365 2.081-0.793 3.102-1.274 0.917-0.432 1.804-0.889 2.662-1.401 0.837-0.5 1.64-1.048 2.438-1.634 0.927-0.679 1.807-1.391 2.645-2.161 0.338-0.31 0.723-0.531 1.050-0.858l51.736-51.736c12.205-12.197 12.205-31.993-0.002-44.188z"
          p-id="5845" fill="#ffffff"></path>
        <path
          d="M709.159 558.289c-16.519-4.923-33.935 4.496-38.858 21.036-20.303 68.215-84.257 115.852-155.513 115.852-71.262 0-135.215-47.647-155.518-115.852-0.135-0.455-0.376-0.845-0.53-1.29-0.363-1.053-0.79-2.076-1.27-3.093-0.432-0.919-0.89-1.805-1.403-2.665-0.498-0.834-1.044-1.633-1.626-2.428-0.685-0.936-1.404-1.824-2.182-2.669-0.306-0.334-0.525-0.715-0.848-1.039-0.328-0.33-0.717-0.553-1.057-0.864-0.847-0.775-1.724-1.489-2.647-2.163-0.781-0.573-1.566-1.112-2.384-1.604-0.879-0.526-1.78-0.989-2.706-1.425-0.919-0.434-1.835-0.84-2.783-1.179-0.939-0.337-1.891-0.602-2.862-0.848-0.976-0.247-1.943-0.468-2.934-0.619-0.992-0.152-1.985-0.231-2.994-0.288-1.029-0.056-2.046-0.080-3.076-0.036-0.953 0.041-1.898 0.142-2.856 0.273-1.129 0.153-2.237 0.363-3.346 0.639-0.454 0.114-0.909 0.125-1.362 0.26-0.444 0.132-0.825 0.366-1.258 0.517-1.073 0.37-2.116 0.804-3.152 1.296-0.898 0.425-1.768 0.873-2.609 1.374-0.852 0.508-1.669 1.064-2.479 1.661-0.918 0.674-1.79 1.379-2.622 2.143-0.34 0.311-0.729 0.535-1.057 0.864l-51.736 51.736c-12.207 12.197-12.207 31.992 0 44.188 6.098 6.103 14.099 9.156 22.094 9.156s15.996-3.051 22.094-9.156l19.26-19.26c39.234 69.4 114.004 114.869 195.853 114.869 98.701 0 187.281-66.007 215.408-160.528 4.92-16.54-4.499-33.935-21.039-38.858z"
          p-id="5846" fill="#ffffff"></path>
      </svg>
    </div>
    <van-action-sheet v-model="actionShow" :actions="deviceList" description="请选择设备" @select="actionSelect"
      cancel-text="取消" close-on-click-action>
    </van-action-sheet>
    <!-- 切换摄像头 -->

    <!-- 镜像 -->
    <div class="FlipHorizontal-toggle" :class="{FlipHorizontalIng:flipHorizontal}" title="左右镜像"
      @click="triggerToggleFlipHorizontal">
      <svg t="1663289810507" class="icon" viewBox="0 0 1117 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
        p-id="3494" width="128" height="128">
        <path
          d="M442.898361 116.049051l2.23404 0.74468L74.840328 1.368349A61.901515 61.901515 0 0 0 0 61.966675v883.283427a61.9946 61.9946 0 0 0 74.840328 60.598326l379.507486-118.124847a77.074368 77.074368 0 0 0 41.981329-68.510549V189.58619a77.539793 77.539793 0 0 0-53.430782-73.537139zM403.244157 792.218386L93.084986 874.412428V132.618179l310.159171 82.380212v577.12691zM1054.466716 0.065159a77.260538 77.260538 0 0 0-12.845728 1.30319L675.796995 115.490542l1.30319-0.18617a77.446708 77.446708 0 0 0-56.968012 74.467988v629.161417c0 29.88028 17.034552 55.850991 41.981329 68.696719l379.228231 118.217932a61.9946 61.9946 0 0 0 75.026498-60.691411V61.966675a61.529175 61.529175 0 0 0-61.901515-61.808431z"
          fill="#ffffff" opacity=".801" p-id="3495">
        </path>
      </svg>
    </div>
    <!-- 镜像 -->
  </div>
  <script>
    "use strict";

    function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
    function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return _typeof(key) === "symbol" ? key : String(key); }
    function _toPrimitive(input, hint) { if (_typeof(input) !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (_typeof(res) !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
    function _regeneratorRuntime() { "use strict"; /*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */ _regeneratorRuntime = function _regeneratorRuntime() { return exports; }; var exports = {}, Op = Object.prototype, hasOwn = Op.hasOwnProperty, defineProperty = Object.defineProperty || function (obj, key, desc) { obj[key] = desc.value; }, $Symbol = "function" == typeof Symbol ? Symbol : {}, iteratorSymbol = $Symbol.iterator || "@@iterator", asyncIteratorSymbol = $Symbol.asyncIterator || "@@asyncIterator", toStringTagSymbol = $Symbol.toStringTag || "@@toStringTag"; function define(obj, key, value) { return Object.defineProperty(obj, key, { value: value, enumerable: !0, configurable: !0, writable: !0 }), obj[key]; } try { define({}, ""); } catch (err) { define = function define(obj, key, value) { return obj[key] = value; }; } function wrap(innerFn, outerFn, self, tryLocsList) { var protoGenerator = outerFn && outerFn.prototype instanceof Generator ? outerFn : Generator, generator = Object.create(protoGenerator.prototype), context = new Context(tryLocsList || []); return defineProperty(generator, "_invoke", { value: makeInvokeMethod(innerFn, self, context) }), generator; } function tryCatch(fn, obj, arg) { try { return { type: "normal", arg: fn.call(obj, arg) }; } catch (err) { return { type: "throw", arg: err }; } } exports.wrap = wrap; var ContinueSentinel = {}; function Generator() { } function GeneratorFunction() { } function GeneratorFunctionPrototype() { } var IteratorPrototype = {}; define(IteratorPrototype, iteratorSymbol, function () { return this; }); var getProto = Object.getPrototypeOf, NativeIteratorPrototype = getProto && getProto(getProto(values([]))); NativeIteratorPrototype && NativeIteratorPrototype !== Op && hasOwn.call(NativeIteratorPrototype, iteratorSymbol) && (IteratorPrototype = NativeIteratorPrototype); var Gp = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(IteratorPrototype); function defineIteratorMethods(prototype) { ["next", "throw", "return"].forEach(function (method) { define(prototype, method, function (arg) { return this._invoke(method, arg); }); }); } function AsyncIterator(generator, PromiseImpl) { function invoke(method, arg, resolve, reject) { var record = tryCatch(generator[method], generator, arg); if ("throw" !== record.type) { var result = record.arg, value = result.value; return value && "object" == _typeof(value) && hasOwn.call(value, "__await") ? PromiseImpl.resolve(value.__await).then(function (value) { invoke("next", value, resolve, reject); }, function (err) { invoke("throw", err, resolve, reject); }) : PromiseImpl.resolve(value).then(function (unwrapped) { result.value = unwrapped, resolve(result); }, function (error) { return invoke("throw", error, resolve, reject); }); } reject(record.arg); } var previousPromise; defineProperty(this, "_invoke", { value: function value(method, arg) { function callInvokeWithMethodAndArg() { return new PromiseImpl(function (resolve, reject) { invoke(method, arg, resolve, reject); }); } return previousPromise = previousPromise ? previousPromise.then(callInvokeWithMethodAndArg, callInvokeWithMethodAndArg) : callInvokeWithMethodAndArg(); } }); } function makeInvokeMethod(innerFn, self, context) { var state = "suspendedStart"; return function (method, arg) { if ("executing" === state) throw new Error("Generator is already running"); if ("completed" === state) { if ("throw" === method) throw arg; return doneResult(); } for (context.method = method, context.arg = arg; ;) { var delegate = context.delegate; if (delegate) { var delegateResult = maybeInvokeDelegate(delegate, context); if (delegateResult) { if (delegateResult === ContinueSentinel) continue; return delegateResult; } } if ("next" === context.method) context.sent = context._sent = context.arg; else if ("throw" === context.method) { if ("suspendedStart" === state) throw state = "completed", context.arg; context.dispatchException(context.arg); } else "return" === context.method && context.abrupt("return", context.arg); state = "executing"; var record = tryCatch(innerFn, self, context); if ("normal" === record.type) { if (state = context.done ? "completed" : "suspendedYield", record.arg === ContinueSentinel) continue; return { value: record.arg, done: context.done }; } "throw" === record.type && (state = "completed", context.method = "throw", context.arg = record.arg); } }; } function maybeInvokeDelegate(delegate, context) { var methodName = context.method, method = delegate.iterator[methodName]; if (undefined === method) return context.delegate = null, "throw" === methodName && delegate.iterator["return"] && (context.method = "return", context.arg = undefined, maybeInvokeDelegate(delegate, context), "throw" === context.method) || "return" !== methodName && (context.method = "throw", context.arg = new TypeError("The iterator does not provide a '" + methodName + "' method")), ContinueSentinel; var record = tryCatch(method, delegate.iterator, context.arg); if ("throw" === record.type) return context.method = "throw", context.arg = record.arg, context.delegate = null, ContinueSentinel; var info = record.arg; return info ? info.done ? (context[delegate.resultName] = info.value, context.next = delegate.nextLoc, "return" !== context.method && (context.method = "next", context.arg = undefined), context.delegate = null, ContinueSentinel) : info : (context.method = "throw", context.arg = new TypeError("iterator result is not an object"), context.delegate = null, ContinueSentinel); } function pushTryEntry(locs) { var entry = { tryLoc: locs[0] }; 1 in locs && (entry.catchLoc = locs[1]), 2 in locs && (entry.finallyLoc = locs[2], entry.afterLoc = locs[3]), this.tryEntries.push(entry); } function resetTryEntry(entry) { var record = entry.completion || {}; record.type = "normal", delete record.arg, entry.completion = record; } function Context(tryLocsList) { this.tryEntries = [{ tryLoc: "root" }], tryLocsList.forEach(pushTryEntry, this), this.reset(!0); } function values(iterable) { if (iterable) { var iteratorMethod = iterable[iteratorSymbol]; if (iteratorMethod) return iteratorMethod.call(iterable); if ("function" == typeof iterable.next) return iterable; if (!isNaN(iterable.length)) { var i = -1, next = function next() { for (; ++i < iterable.length;) if (hasOwn.call(iterable, i)) return next.value = iterable[i], next.done = !1, next; return next.value = undefined, next.done = !0, next; }; return next.next = next; } } return { next: doneResult }; } function doneResult() { return { value: undefined, done: !0 }; } return GeneratorFunction.prototype = GeneratorFunctionPrototype, defineProperty(Gp, "constructor", { value: GeneratorFunctionPrototype, configurable: !0 }), defineProperty(GeneratorFunctionPrototype, "constructor", { value: GeneratorFunction, configurable: !0 }), GeneratorFunction.displayName = define(GeneratorFunctionPrototype, toStringTagSymbol, "GeneratorFunction"), exports.isGeneratorFunction = function (genFun) { var ctor = "function" == typeof genFun && genFun.constructor; return !!ctor && (ctor === GeneratorFunction || "GeneratorFunction" === (ctor.displayName || ctor.name)); }, exports.mark = function (genFun) { return Object.setPrototypeOf ? Object.setPrototypeOf(genFun, GeneratorFunctionPrototype) : (genFun.__proto__ = GeneratorFunctionPrototype, define(genFun, toStringTagSymbol, "GeneratorFunction")), genFun.prototype = Object.create(Gp), genFun; }, exports.awrap = function (arg) { return { __await: arg }; }, defineIteratorMethods(AsyncIterator.prototype), define(AsyncIterator.prototype, asyncIteratorSymbol, function () { return this; }), exports.AsyncIterator = AsyncIterator, exports.async = function (innerFn, outerFn, self, tryLocsList, PromiseImpl) { void 0 === PromiseImpl && (PromiseImpl = Promise); var iter = new AsyncIterator(wrap(innerFn, outerFn, self, tryLocsList), PromiseImpl); return exports.isGeneratorFunction(outerFn) ? iter : iter.next().then(function (result) { return result.done ? result.value : iter.next(); }); }, defineIteratorMethods(Gp), define(Gp, toStringTagSymbol, "Generator"), define(Gp, iteratorSymbol, function () { return this; }), define(Gp, "toString", function () { return "[object Generator]"; }), exports.keys = function (val) { var object = Object(val), keys = []; for (var key in object) keys.push(key); return keys.reverse(), function next() { for (; keys.length;) { var key = keys.pop(); if (key in object) return next.value = key, next.done = !1, next; } return next.done = !0, next; }; }, exports.values = values, Context.prototype = { constructor: Context, reset: function reset(skipTempReset) { if (this.prev = 0, this.next = 0, this.sent = this._sent = undefined, this.done = !1, this.delegate = null, this.method = "next", this.arg = undefined, this.tryEntries.forEach(resetTryEntry), !skipTempReset) for (var name in this) "t" === name.charAt(0) && hasOwn.call(this, name) && !isNaN(+name.slice(1)) && (this[name] = undefined); }, stop: function stop() { this.done = !0; var rootRecord = this.tryEntries[0].completion; if ("throw" === rootRecord.type) throw rootRecord.arg; return this.rval; }, dispatchException: function dispatchException(exception) { if (this.done) throw exception; var context = this; function handle(loc, caught) { return record.type = "throw", record.arg = exception, context.next = loc, caught && (context.method = "next", context.arg = undefined), !!caught; } for (var i = this.tryEntries.length - 1; i >= 0; --i) { var entry = this.tryEntries[i], record = entry.completion; if ("root" === entry.tryLoc) return handle("end"); if (entry.tryLoc <= this.prev) { var hasCatch = hasOwn.call(entry, "catchLoc"), hasFinally = hasOwn.call(entry, "finallyLoc"); if (hasCatch && hasFinally) { if (this.prev < entry.catchLoc) return handle(entry.catchLoc, !0); if (this.prev < entry.finallyLoc) return handle(entry.finallyLoc); } else if (hasCatch) { if (this.prev < entry.catchLoc) return handle(entry.catchLoc, !0); } else { if (!hasFinally) throw new Error("try statement without catch or finally"); if (this.prev < entry.finallyLoc) return handle(entry.finallyLoc); } } } }, abrupt: function abrupt(type, arg) { for (var i = this.tryEntries.length - 1; i >= 0; --i) { var entry = this.tryEntries[i]; if (entry.tryLoc <= this.prev && hasOwn.call(entry, "finallyLoc") && this.prev < entry.finallyLoc) { var finallyEntry = entry; break; } } finallyEntry && ("break" === type || "continue" === type) && finallyEntry.tryLoc <= arg && arg <= finallyEntry.finallyLoc && (finallyEntry = null); var record = finallyEntry ? finallyEntry.completion : {}; return record.type = type, record.arg = arg, finallyEntry ? (this.method = "next", this.next = finallyEntry.finallyLoc, ContinueSentinel) : this.complete(record); }, complete: function complete(record, afterLoc) { if ("throw" === record.type) throw record.arg; return "break" === record.type || "continue" === record.type ? this.next = record.arg : "return" === record.type ? (this.rval = this.arg = record.arg, this.method = "return", this.next = "end") : "normal" === record.type && afterLoc && (this.next = afterLoc), ContinueSentinel; }, finish: function finish(finallyLoc) { for (var i = this.tryEntries.length - 1; i >= 0; --i) { var entry = this.tryEntries[i]; if (entry.finallyLoc === finallyLoc) return this.complete(entry.completion, entry.afterLoc), resetTryEntry(entry), ContinueSentinel; } }, "catch": function _catch(tryLoc) { for (var i = this.tryEntries.length - 1; i >= 0; --i) { var entry = this.tryEntries[i]; if (entry.tryLoc === tryLoc) { var record = entry.completion; if ("throw" === record.type) { var thrown = record.arg; resetTryEntry(entry); } return thrown; } } throw new Error("illegal catch attempt"); }, delegateYield: function delegateYield(iterable, resultName, nextLoc) { return this.delegate = { iterator: values(iterable), resultName: resultName, nextLoc: nextLoc }, "next" === this.method && (this.arg = undefined), ContinueSentinel; } }, exports; }
    function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }
    function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }
    function _typeof(obj) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) { return typeof obj; } : function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }, _typeof(obj); }
    new Vue({
      el: '#app',
      data: {
        width: 280,
        height: 280,
        actionShow: false,
        deviceList: [],
        //设备列表
        deviceId: window.localStorage.getItem("deviceId") || '',
        //设备id
        isCameraOpen: false,
        //相机是否打开
        inProgress: false,
        //是否正在录制
        mediaRecorder: null,
        //录制器
        mediaStreamTrack: null,
        //音频或视频流
        blob: null,
        //录制的视频
        ModelLoading: false,
        //模型加载中
        detector: null,
        //识别模型
        rafId: null,
        flipHorizontal: false,
        //镜像
        faceNullFrequency: 0,
        isFarArr: [],
        //记录远近
        isOpenMouthArr: [],
        //张嘴
        isWinkArr: [],
        //眨眼
        isShakingHisHeadArr: [],
        //摇头
        actionList: [{
          name: "远一些",
          value: 0
        }, {
          name: "近一些",
          value: 1
        }, {
          name: "张嘴",
          value: 2
        }, {
          name: "眨眼",
          value: 3
        }, {
          name: "向左转头",
          value: 4
        }, {
          name: "向右转头",
          value: 5
        }],
        //动作列表
        currentAction: [],
        //当前动作
        currentRate: 0,
        nextactionTime: 0
      },
      mounted: function mounted() {
        var size = (document.documentElement.clientWidth || window.innerWidth) * 0.6;
        this.width = size > 280 ? 280 : size;
        this.height = size > 280 ? 280 : size;

        // 一堆兼容代码
        this.compatible();
        this.openUserMedia();
      },
      methods: {
        isObjEmpty: function isObjEmpty(obj) {
          return obj === undefined || obj === "undefined" || obj == null || obj === "" || obj.length === 0 || _typeof(obj) === "object" && Object.keys(obj).length === 0;
        },
        neuAufnehmen: function neuAufnehmen() {
          var _this = this;
          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {
            return _regeneratorRuntime().wrap(function _callee$(_context) {
              while (1) switch (_context.prev = _context.next) {
                case 0:
                  _context.next = 2;
                  return _this.getUserMedia();
                case 2:
                  _context.next = 4;
                  return _this.createDetector();
                case 4:
                  _context.next = 6;
                  return _this.startMediaRecorder();
                case 6:
                case "end":
                  return _context.stop();
              }
            }, _callee);
          }))();
        },
        //打开摄像头
        openUserMedia: function openUserMedia() {
          var _this2 = this;
          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {
            var isOpen;
            return _regeneratorRuntime().wrap(function _callee2$(_context2) {
              while (1) switch (_context2.prev = _context2.next) {
                case 0:
                  _context2.next = 2;
                  return _this2.getUserMedia();
                case 2:
                  isOpen = _context2.sent;
                  if (!(isOpen.code == "ok")) {
                    _context2.next = 9;
                    break;
                  }
                  _context2.next = 6;
                  return _this2.createDetector();
                case 6:
                  vant.Toast("\u6444\u50CF\u5934\u5DF2\u6253\u5F00");
                  _context2.next = 11;
                  break;
                case 9:
                  vant.Dialog.alert({
                    title: '失败',
                    message: "\u6253\u5F00\u6444\u50CF\u5934\u5931\u8D25\uFF1A".concat(isOpen.errMsg),
                    theme: 'round-button'
                  }).then(function () {
                    location.replace("".concat(location.pathname, "?s=").concat(new Date().getTime()));
                  });
                  return _context2.abrupt("return");
                case 11:
                  ;
                case 12:
                case "end":
                  return _context2.stop();
              }
            }, _callee2);
          }))();
        },
        getUserMedia: function getUserMedia() {
          var _this3 = this;
          return new Promise( /*#__PURE__*/function () {
            var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(resolve) {
              var toast, mediaOpts, stream, video;
              return _regeneratorRuntime().wrap(function _callee3$(_context3) {
                while (1) switch (_context3.prev = _context3.next) {
                  case 0:
                    _this3.inProgress = false;
                    _this3.isCameraOpen = false;
                    _this3.blob = null;
                    toast = vant.Toast.loading({
                      duration: 0,
                      // 持续展示 toast
                      forbidClick: true,
                      message: '打开摄像头'
                    });
                    mediaOpts = _defineProperty({
                      audio: false,
                      video: true
                    }, "video", {
                      width: _this3.width,
                      height: _this3.height,
                      frameRate: {
                        ideal: 100,
                        max: 150
                      } //最佳帧率
                    });

                    if (_this3.isObjEmpty(_this3.deviceId)) {
                      mediaOpts.video.facingMode = "user"; //前置摄像头
                      // mediaOpts.video.facingMode = "environment"; //后置摄像头
                    } else {
                      mediaOpts.video.deviceId = _this3.deviceId;
                    }
                    _context3.prev = 6;
                    _context3.next = 9;
                    return navigator.mediaDevices.getUserMedia(mediaOpts);
                  case 9:
                    stream = _context3.sent;
                    _this3.mediaStreamTrack = stream;
                    //获取设备
                    _context3.next = 13;
                    return _this3.getDevice();
                  case 13:
                    _context3.t0 = _context3.sent;
                    if (_context3.t0) {
                      _context3.next = 16;
                      break;
                    }
                    _context3.t0 = [];
                  case 16:
                    _this3.deviceList = _context3.t0;
                    video = _this3.$refs['video'];
                    video.pause();
                    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                    if ("srcObject" in video) {
                      video.srcObject = stream;
                    } else {
                      video.src = window.URL && window.URL.createObjectURL(stream) || stream;
                    }
                    ;
                    video.play();
                    video.onplay = function () {
                      toast.clear();
                      _this3.isCameraOpen = true;
                      resolve({
                        code: "ok"
                      });
                    };
                    _context3.next = 31;
                    break;
                  case 26:
                    _context3.prev = 26;
                    _context3.t1 = _context3["catch"](6);
                    toast.clear();
                    console.error(_context3.t1);
                    resolve({
                      errMsg: _context3.t1
                    });
                  case 31:
                  case "end":
                    return _context3.stop();
                }
              }, _callee3, null, [[6, 26]]);
            }));
            return function (_x) {
              return _ref.apply(this, arguments);
            };
          }());
        },
        startMediaRecorder: function startMediaRecorder() {
          var _this4 = this;
          return new Promise( /*#__PURE__*/function () {
            var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4(resolve) {
              var toast;
              return _regeneratorRuntime().wrap(function _callee4$(_context4) {
                while (1) switch (_context4.prev = _context4.next) {
                  case 0:
                    if (typeof MediaRecorder === "function") {
                      _this4.isFarArr = []; //记录远近
                      _this4.isOpenMouthArr = []; //张嘴
                      _this4.isWinkArr = []; //眨眼
                      _this4.isShakingHisHeadArr = []; //摇头
                      _this4.inProgress = false;
                      toast = vant.Toast.loading({
                        duration: 0,
                        // 持续展示 toast
                        forbidClick: true,
                        message: '准备录制'
                      });
                      _this4.mediaRecorder = new MediaRecorder(_this4.mediaStreamTrack, {
                        audioBitsPerSecond: 0,
                        //音频码率
                        videoBitsPerSecond: 1000000 * 20 //视频码率 (数值越大视频越清晰)
                        // mimeType: 'video/webm;codecs=h264' //视频编码格式
                      });

                      _this4.mediaRecorder.start();
                      // this.mediaRecorder.resume();
                      _this4.mediaRecorder.ondataavailable = function (e) {
                        _this4.blob = new Blob([e.data], {
                          'type': e.currentTarget.mimeType
                        });
                      };
                      _this4.mediaRecorder.onerror = function (e) {
                        _this4.inProgress = false;
                        console.error(e);
                        toast.clear();
                        resolve({
                          errMsg: e
                        });
                      };
                      _this4.mediaRecorder.onstart = function (e) {
                        _this4.inProgress = true;
                        console.log('开始', e);
                        toast.clear();
                        vant.Toast("\u5F00\u59CB\u5F55\u5236");
                        resolve({
                          code: "ok"
                        });
                      };
                      _this4.mediaRecorder.onresume = function (e) {
                        _this4.inProgress = true;
                        console.log('恢复', e);
                        toast.clear();
                        resolve({
                          code: "ok"
                        });
                      };
                      _this4.mediaRecorder.onstop = function (e) {
                        _this4.inProgress = false;
                        var saveFile = vant.Toast.loading({
                          duration: 0,
                          // 持续展示 toast
                          forbidClick: true,
                          message: '保存视频中'
                        });
                        console.log('结束', e);
                        var url = window.URL && window.URL.createObjectURL(_this4.blob);
                        vant.Dialog.confirm({
                          title: '录制完成',
                          message: "\n                                <video src=\"".concat(url, "#t=0.01\" style=\"display: block;width: 100%;\" webkit-playsinline=\"true\" playsinline=\"true\" controls autoplay></video>\n                                <div class=\"van-cell van-cell--center\">\n                                    <div class=\"van-cell__title\" style=\"text-align: left;\">\n                                        <span>\u6587\u4EF6\u5927\u5C0F</span>\n                                    </div>\n                                    <div class=\"van-cell__value\">\n                                        <span>").concat((_this4.blob.size / 1024).toFixed(2), "kb</span>\n                                    </div>\n                                </div>\n                            "),
                          theme: 'round-button',
                          className: 'videoDialog',
                          confirmButtonText: '上传'
                        }).then(function () {
                          vant.Toast("\u4E0A\u4F20\u6210\u529F\uFF01");
                        });
                        saveFile.clear();
                      };
                    } else {
                      vant.Dialog.alert({
                        title: '失败',
                        message: "\u5F55\u5236\u5931\u8D25\uFF1A\u6D4F\u89C8\u5668\u4E0D\u652F\u6301new MediaRecorder\u65B9\u6CD5",
                        theme: 'round-button'
                      }).then(function () {
                        // location.replace(`${location.pathname}?s=${new Date().getTime()}`)
                      });
                    }
                  case 1:
                  case "end":
                    return _context4.stop();
                }
              }, _callee4);
            }));
            return function (_x2) {
              return _ref2.apply(this, arguments);
            };
          }());
        },
        StopMediaRecorder: function StopMediaRecorder() {
          var _this5 = this;
          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {
            var toast;
            return _regeneratorRuntime().wrap(function _callee5$(_context5) {
              while (1) switch (_context5.prev = _context5.next) {
                case 0:
                  _this5.inProgress = false;
                  _this5.isCameraOpen = false;
                  toast = vant.Toast.loading({
                    duration: 0,
                    // 持续展示 toast
                    forbidClick: true,
                    message: '已完成！保存视频中'
                  });
                  _context5.next = 5;
                  return _this5.delay(5);
                case 5:
                  //所有动作结束以后 延迟五秒关闭录制。
                  _this5.mediaStreamTrack.getVideoTracks().forEach(function (track) {
                    track.stop();
                  });
                  _this5.mediaRecorder && _this5.mediaRecorder.stop();
                  toast.clear();
                case 8:
                case "end":
                  return _context5.stop();
              }
            }, _callee5);
          }))();
        },
        //镜像切换
        triggerToggleFlipHorizontal: function triggerToggleFlipHorizontal() {
          this.flipHorizontal = !this.flipHorizontal;
          var video = this.$refs['video'];
          if (this.flipHorizontal) {
            video.style.transform = 'scale(-1, 1)';
          } else {
            video.style.transform = 'scale(1, 1)';
          }
          ;
          this.createDetector();
        },
        //随机生成动作
        generateAction: function generateAction() {
          this.$refs.actionSwipe.swipeTo(0);
          this.currentRate = 0;
          this.currentAction = this.actionList.map(function (e) {
            e.complete = false;
            e.time = 0;
            return e;
          }).sort(function (_) {
            return Math.random() > 0.5 ? -1 : 1;
          });
          console.log(this.currentAction);
        },
        //显示当前动作
        showCurrentAction: function showCurrentAction() {
          var name = '';
          var array = this.currentAction;
          for (var index = 0; index < array.length; index++) {
            var element = array[index];
            if (element.complete === false) {
              name = element.name;
              break;
            }
          }
          return name;
        },
        //触发动作
        triggerAction: function triggerAction(actionValue) {
          if (this.isCameraOpen && this.inProgress) {
            var index = this.currentAction.findIndex(function (e) {
              return !e.complete;
            });
            var findObj = this.currentAction.find(function (e) {
              return !e.complete;
            }) || {};
            var deffTime = new Date().getTime() - this.nextactionTime;
            //两个动作间隔3s
            if (findObj.value === actionValue && deffTime >= 3000) {
              this.nextactionTime = new Date().getTime();
              findObj.complete = true;
              this.$set(this.currentAction, index, findObj);
              var num = this.currentAction.filter(function (e) {
                return e.complete;
              }).length;
              this.currentRate = this.GetPercent(num, this.currentAction.length);
              this.$refs.actionSwipe.next();
            }
            ;
            var isComplete = this.currentAction.every(function (e) {
              return e.complete === true;
            });
            if (isComplete) {
              this.StopMediaRecorder();
            }
          }
        },
        //创建识别模型
        createDetector: function createDetector() {
          var _this6 = this;
          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee7() {
            return _regeneratorRuntime().wrap(function _callee7$(_context7) {
              while (1) switch (_context7.prev = _context7.next) {
                case 0:
                  return _context7.abrupt("return", new Promise( /*#__PURE__*/function () {
                    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee6(resolve) {
                      var toast, model, detectorConfig;
                      return _regeneratorRuntime().wrap(function _callee6$(_context6) {
                        while (1) switch (_context6.prev = _context6.next) {
                          case 0:
                            _this6.generateAction(); //生成模型
                            toast = vant.Toast.loading({
                              duration: 0,
                              // 持续展示 toast
                              forbidClick: true,
                              message: '加载模型中（首次加载需要1-2分钟）'
                            });
                            _this6.ModelLoading = true;
                            _context6.prev = 3;
                            if (!_this6.isObjEmpty(_this6.detector)) {
                              _this6.detector.dispose();
                            }
                            ;
                            if (!_this6.isObjEmpty(_this6.rafId)) {
                              window.cancelAnimationFrame(_this6.rafId);
                              _this6.rafId = null;
                            }
                            ;
                            model = faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh;
                            detectorConfig = {
                              maxFaces: 1,
                              //检测到的最大面部数量
                              refineLandmarks: true,
                              //可以完善眼睛和嘴唇周围的地标坐标，并在虹膜周围输出其他地标
                              runtime: 'mediapipe',
                              solutionPath: 'https://unpkg.com/@mediapipe/face_mesh' //WASM二进制文件和模型文件所在的路径
                            };
                            _context6.next = 12;
                            return faceLandmarksDetection.createDetector(model, detectorConfig);
                          case 12:
                            _this6.detector = _context6.sent;
                            toast.clear();
                            _this6.rafId = window.requestAnimationFrame(_this6.renderPrediction);
                            resolve({
                              code: "ok"
                            });
                            _context6.next = 25;
                            break;
                          case 18:
                            _context6.prev = 18;
                            _context6.t0 = _context6["catch"](3);
                            toast.clear();
                            _this6.ModelLoading = false;
                            // vant.Dialog.alert({
                            //     title: '失败',
                            //     message: `创建识别模型失败-${error}`,
                            //     theme: 'round-button',
                            // }).then(() => {
                            //     location.replace(`${location.pathname}?s=${new Date().getTime()}`)
                            // });
                            _this6.detector = null;
                            console.log(_context6.t0);
                            resolve({
                              errMsg: _context6.t0
                            });
                          case 25:
                          case "end":
                            return _context6.stop();
                        }
                      }, _callee6, null, [[3, 18]]);
                    }));
                    return function (_x3) {
                      return _ref3.apply(this, arguments);
                    };
                  }()));
                case 1:
                case "end":
                  return _context7.stop();
              }
            }, _callee7);
          }))();
        },
        //预测
        renderPrediction: function renderPrediction() {
          var _this7 = this;
          return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee8() {
            var video, canvas, context, Faces;
            return _regeneratorRuntime().wrap(function _callee8$(_context8) {
              while (1) switch (_context8.prev = _context8.next) {
                case 0:
                  video = _this7.$refs['video'];
                  canvas = _this7.$refs['canvas'];
                  context = canvas.getContext('2d');
                  if (!(_this7.detector && _this7.isCameraOpen)) {
                    _context8.next = 23;
                    break;
                  }
                  _context8.prev = 4;
                  context.clearRect(0, 0, canvas.width, canvas.height);
                  _context8.next = 8;
                  return _this7.detector.estimateFaces(video, {
                    flipHorizontal: _this7.flipHorizontal //镜像
                  });
                case 8:
                  Faces = _context8.sent;
                  _this7.ModelLoading = false;
                  if (Faces.length > 0) {
                    _this7.faceNullFrequency = 0;
                    _this7.drawResults(Faces, context);
                  } else {
                    _this7.faceNullFrequency++;
                    //连续5帧没有检测到人脸提示
                    if (_this7.faceNullFrequency >= 5) {
                      vant.Toast("\u6CA1\u6709\u68C0\u6D4B\u5230\u4EBA\u8138");
                    }
                  }
                  _context8.next = 20;
                  break;
                case 13:
                  _context8.prev = 13;
                  _context8.t0 = _context8["catch"](4);
                  _this7.createDetector();
                  _this7.ModelLoading = false;
                  vant.Toast("\u9884\u6D4B-".concat(_context8.t0));
                  console.log(_context8.t0);
                  context.clearRect(0, 0, canvas.width, canvas.height);
                case 20:
                  _this7.rafId = window.requestAnimationFrame(_this7.renderPrediction);
                  _context8.next = 25;
                  break;
                case 23:
                  context.clearRect(0, 0, canvas.width, canvas.height);
                  _this7.rafId = window.requestAnimationFrame(_this7.renderPrediction);
                case 25:
                case "end":
                  return _context8.stop();
              }
            }, _callee8, null, [[4, 13]]);
          }))();
        },
        //绘制
        drawResults: function drawResults(faces, ctx) {
          var _this8 = this;
          faces.forEach(function (faceItem) {
            ctx.fillStyle = '#1af117';
            (faceItem.keypoints || []).forEach(function (element, index) {
              /* arc */
              ctx.beginPath();
              ctx.arc(element.x, element.y, 1, 0, 2 * Math.PI);
              ctx.fill();
              /* arc */
            });

            var faceProportion = _this8.GetPercent(faceItem.box.width * faceItem.box.height, _this8.width * _this8.height);
            _this8.$refs['faceProportion'].innerHTML = "10-50\u4E4B\u95F4,\u5F53\u524D\u8DDD\u79BB:<b>".concat(Math.round(faceProportion), "</b>");
            if (faceProportion <= 10) {
              vant.Toast("\u8DDD\u79BB\u592A\u8FDC");
              return;
            }
            ;
            if (faceProportion >= 50) {
              vant.Toast("\u8DDD\u79BB\u592A\u8FD1");
              return;
            }
            ;
            if (_this8.isCameraOpen && _this8.inProgress) {
              //靠近&远离
              _this8.isFarAndNear(faceItem);

              //张嘴
              _this8.isOpenMouth(faceItem, ctx);

              //眨眼
              _this8.isWink(faceItem, ctx);

              //摇头
              _this8.isShakingHisHead(faceItem, ctx);
            }
          });
        },
        //靠近&远离
        isFarAndNear: function isFarAndNear(face) {
          var proportion = this.GetPercent(face.box.width * face.box.height, this.width * this.height);
          this.isFarArr.push(proportion);
          //计算4帧的动态变化
          if (this.isFarArr.length > 4) {
            this.isFarArr.shift();
            if (this.Increment(this.isFarArr) || this.Decrease(this.isFarArr)) {
              var first = this.isFarArr[0];
              var last = this.isFarArr[this.isFarArr.length - 1];
              var diff = this.GetPercent(first - last, first + last);
              if (diff <= -5) {
                // this.log(`【动作】靠近`, `info`);
                this.triggerAction(1);
              }
              ;
              if (diff >= 5) {
                // this.log(`【动作】远离`, `primary`);
                this.triggerAction(0);
              }
              ;
            }
          }
          ;
        },
        //张嘴
        isOpenMouth: function isOpenMouth(face, ctx) {
          var featureIndex1 = [0, 17];
          var featureLocation1 = [];
          var featureIndex2 = [10, 152];
          var featureLocation2 = [];
          (face.keypoints || []).forEach(function (element, index) {
            if (featureIndex1.includes(index)) {
              featureLocation1.push([element.x, element.y]);
            }
            if (featureIndex2.includes(index)) {
              featureLocation2.push([element.x, element.y]);
            }
          });

          // 10,152占0,17的比例
          var proportion = this.GetPercent(this.getDistance(featureLocation1[0][0], featureLocation1[0][1], featureLocation1[1][0], featureLocation1[1][1]), this.getDistance(featureLocation2[0][0], featureLocation2[0][1], featureLocation2[1][0], featureLocation2[1][1]));
          this.isOpenMouthArr.push(proportion);

          //计算2帧的动态变化
          if (this.isOpenMouthArr.length > 2) {
            this.isOpenMouthArr.shift();
            if (this.Increment(this.isOpenMouthArr)) {
              var first = this.isOpenMouthArr[0];
              var last = this.isOpenMouthArr[this.isOpenMouthArr.length - 1];
              var diff = this.GetPercent(first - last, first + last);
              if (diff <= -5) {
                // this.log(`【动作】张嘴`, `info`);
                this.triggerAction(2);
              }
              ;
            }
          }
        },
        //眨眼
        isWink: function isWink(face, ctx) {
          var leftEye = [159, 144];
          var leftEyeLocation = [];
          var rightEye = [385, 374];
          var rightEyeLocation = [];
          (face.keypoints || []).forEach(function (element, index) {
            if (leftEye.includes(index)) {
              leftEyeLocation.push([element.x, element.y]);
            }
            if (rightEye.includes(index)) {
              rightEyeLocation.push([element.x, element.y]);
            }
          });
          var leftProportion = this.getDistance(leftEyeLocation[0][0], leftEyeLocation[0][1], leftEyeLocation[1][0], leftEyeLocation[1][1]);
          var rightProportion = this.getDistance(rightEyeLocation[0][0], rightEyeLocation[0][1], rightEyeLocation[1][0], rightEyeLocation[1][1]);
          if (leftProportion <= 5 || rightProportion <= 5) {
            this.isWinkArr.push([leftProportion, rightProportion]);
            //连续4帧一次
            if (this.isWinkArr.length >= 4) {
              // this.log(`【动作】眨眼`, `info`);
              this.triggerAction(3);
              this.isWinkArr = [];
            }
          } else {
            this.isWinkArr = [];
          }
        },
        //isShakingHisHead
        isShakingHisHead: function isShakingHisHead(face, ctx) {
          var leftFace = [195, 93];
          var leftFaceLocation = [];
          var rightFace = [195, 323];
          var rightFaceLocation = [];
          (face.keypoints || []).forEach(function (element, index) {
            if (leftFace.includes(index)) {
              leftFaceLocation.push([element.x, element.y]);
            }
            if (rightFace.includes(index)) {
              if (rightFaceLocation.length === 0) {
                ctx.moveTo(element.x, element.y);
              } else {
                ctx.lineTo(element.x, element.y);
              }
              rightFaceLocation.push([element.x, element.y]);
            }
          });
          var leftProportion = this.getDistance(leftFaceLocation[0][0], leftFaceLocation[0][1], leftFaceLocation[1][0], leftFaceLocation[1][1]);
          var rightProportion = this.getDistance(rightFaceLocation[0][0], rightFaceLocation[0][1], rightFaceLocation[1][0], rightFaceLocation[1][1]);
          var diff = this.GetPercent(leftProportion - rightProportion, leftProportion + rightProportion);
          this.isShakingHisHeadArr.push(diff); //左 -40 右 40

          //计算4帧的动态变化
          if (this.isShakingHisHeadArr.length > 4) {
            this.isShakingHisHeadArr.shift();
            var isL = this.isShakingHisHeadArr.every(function (e) {
              return e >= -60;
            });
            var isR = this.isShakingHisHeadArr.every(function (e) {
              return e <= 60;
            });
            if (isL) {
              // this.log(`【动作】向左转`, `info`);
              this.triggerAction(4);
            }
            if (isR) {
              // this.log(`【动作】向右转`, `info`);
              this.triggerAction(5);
            }
          }
          ;
          // console.log(diff);
        },
        actionSelect: function actionSelect(value) {
          var deviceId = value.deviceId;
          this.actionShow = false;
          if (!this.isObjEmpty(deviceId) && this.deviceId != deviceId) {
            this.deviceId = deviceId;
            window.localStorage.setItem("deviceId", deviceId);
            this.openUserMedia();
          }
        },
        //获取设备信息
        getDevice: function getDevice() {
          var _this9 = this;
          return new Promise( /*#__PURE__*/function () {
            var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee9(resolve) {
              var toast, devicesList, arr;
              return _regeneratorRuntime().wrap(function _callee9$(_context9) {
                while (1) switch (_context9.prev = _context9.next) {
                  case 0:
                    toast = vant.Toast.loading({
                      duration: 0,
                      // 持续展示 toast
                      forbidClick: true,
                      message: '获取设备中'
                    });
                    _context9.prev = 1;
                    _context9.next = 4;
                    return navigator.mediaDevices.enumerateDevices();
                  case 4:
                    devicesList = _context9.sent;
                    arr = [];
                    (devicesList || []).forEach(function (e) {
                      e.name = e.label || e.deviceId;
                      if (e.kind === "videoinput" && e.deviceId && !e.name.includes('麦克风')) {
                        e.color = e.deviceId == _this9.deviceId ? '#1989fa' : '#323233';
                        arr.push(e);
                      }
                    });
                    toast.clear();
                    console.log(arr);
                    resolve(arr);
                    _context9.next = 17;
                    break;
                  case 12:
                    _context9.prev = 12;
                    _context9.t0 = _context9["catch"](1);
                    toast.clear();
                    console.log(_context9.t0);
                    resolve([]);
                  case 17:
                    ;
                  case 18:
                  case "end":
                    return _context9.stop();
                }
              }, _callee9, null, [[1, 12]]);
            }));
            return function (_x4) {
              return _ref4.apply(this, arguments);
            };
          }());
        },
        // 一堆兼容代码
        compatible: function compatible() {
          window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
          if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
          }
          if (navigator.mediaDevices.getUserMedia === undefined) {
            navigator.mediaDevices.getUserMedia = function (constraints) {
              var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
              if (!getUserMedia) {
                return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
              }
              return new Promise(function (resolve, reject) {
                getUserMedia.call(navigator, constraints, resolve, reject);
              });
            };
          }
        },
        //递增
        Increment: function Increment(array) {
          var is = true;
          for (var i = 0; i < array.length - 1; i++) {
            var n1 = array[i];
            var n2 = array[i + 1];
            if (n1 > n2) {
              is = false;
              break;
            }
          }
          return array.length > 1 ? is : false;
        },
        //递减
        Decrease: function Decrease() {
          var array = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
          var is = true;
          for (var i = 0; i < array.length - 1; i++) {
            var n1 = array[i];
            var n2 = array[i + 1];
            if (n1 < n2) {
              is = false;
              break;
            }
          }
          return array.length > 1 ? is : false;
        },
        //距离
        getDistance: function getDistance(x1, y1, x2, y2) {
          return Math.sqrt((x2 -= x1) * x2 + (y2 -= y1) * y2);
        },
        /**
         * @ 占比计算
         * @ num 当前数
         * @ total 总数
         */
        GetPercent: function GetPercent(num, total) {
          num = parseFloat(num);
          total = parseFloat(total);
          if (isNaN(num) || isNaN(total)) {
            return "-";
          }
          return total <= 0 ? 0 : Math.round(num / total * 10000) / 100.00;
        },
        /**
         * 毫秒数的可读格式
         */
        formatDuration: function formatDuration(time) {
          var h = parseInt(time / 60 / 60 % 24);
          h = h < 10 ? '0' + h : h;
          var m = parseInt(time / 60 % 60);
          m = m < 10 ? '0' + m : m;
          var s = parseInt(time % 60);
          s = s < 10 ? '0' + s : s;
          // 作为返回值返回
          return h === "00" ? [m, s].join(':') : [h, m, s].join(':');
        },
        //延迟
        delay: function delay() {
          var m = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;
          return new Promise(function (res) {
            setTimeout(function () {
              res(true);
            }, m * 1000);
          });
        }
      }
    });
  </script>
</body>

</html>